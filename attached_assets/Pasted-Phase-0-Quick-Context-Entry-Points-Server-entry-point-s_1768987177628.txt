Phase 0 â€” Quick Context / Entry Points
Server entry point: server/index.ts (Express setup + route registration).
Routes: server/routes.ts (all API endpoints).
Client storage: client/lib/storage.ts (cases + timeline + settings).
Client auth: client/lib/auth.ts (JWT handling).
Smart Capture: client/screens/SmartCaptureScreen.tsx (OCR/AI flows).
Privacy promises: replit.md (claims â€œ100% offlineâ€).
ğŸ”´ Phase 1 â€” Critical Security & Privacy Fixes
1) Require JWT_SECRET, remove hardcoded fallback
Why: Current fallback secret allows token forgery if env missing.
Files: server/routes.ts
Actions:
Replace const JWT_SECRET = process.env.JWT_SECRET || "..." with a hard failure if env is missing.
Example behavior: if (!process.env.JWT_SECRET) throw new Error("JWT_SECRET must be set");
ğŸ“ Target: server/routes.ts near top where JWT_SECRET is defined.
2) Protect all flap/anastomosis routes with auth + ownership checks
Why: Currently unauthenticated (IDOR risk).
Files: server/routes.ts, server/storage.ts, shared/schema.ts
Actions:
Add authenticateToken middleware to:
/api/procedures/:procedureId/flaps
/api/flaps (POST/PUT/DELETE)
/api/flaps/:flapId/anastomoses
/api/anastomoses (POST/PUT/DELETE)
Add ownership checks:
Only allow user access to flaps/anastomoses if the parent procedure belongs to their userId.
This likely requires a storage helper that joins flaps â†’ procedures and checks procedures.userId.
ğŸ“ Targets:
Routes: server/routes.ts near flaps/anastomoses sections.
Storage: add helper in server/storage.ts (check ownership).
Schema references: shared/schema.ts (procedures, flaps).
3) Stop logging full JSON response bodies (PHI leak)
Why: /api responses contain patient identifiers.
File: server/index.ts
Actions:
Remove res.json override that captures response bodies.
Keep minimal log line (method/path/status/duration only).
ğŸ“ Target: server/index.ts request logging middleware.
4) Fix privacy mismatch: native Smart Capture uploads raw images
Why: README promises â€œ100% offlineâ€, but native uploads base64 images to server.
Files: client/screens/SmartCaptureScreen.tsx, server/routes.ts, replit.md
Options (choose one):
Preferred: Implement local OCR on native (use Tesseract on device) and send redacted text only (like web flow).
Alternative: If server OCR stays, update privacy claims + add explicit user consent before upload.
ğŸ“ Targets:
Native flow is in SmartCaptureScreen.tsx (images sent to /api/analyze-op-note).
Server endpoint receives images + OCRs them: server/routes.ts in /api/analyze-op-note.
Privacy claims in replit.md.
5) Encrypt local storage for PHI and tokens
Why: AsyncStorage stores PHI & JWTs in plaintext.
Files: client/lib/storage.ts, client/lib/auth.ts
Actions:
Replace AsyncStorage for PHI and JWT with a secure storage approach:
Use SecureStore/Keychain/Keystore for tokens.
Store cases in encrypted SQLite or an encrypted storage layer.
At minimum: tokens must move to secure storage.
ğŸ“ Targets:
Token storage: client/lib/auth.ts.
Case storage: client/lib/storage.ts.