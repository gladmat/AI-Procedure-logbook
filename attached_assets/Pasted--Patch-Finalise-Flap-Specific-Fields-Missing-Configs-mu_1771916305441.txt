# Patch: Finalise Flap-Specific Fields — Missing Configs + multi_select Renderer

This is a small follow-up patch to the flap-specific fields implementation. Three things need fixing:

1. **Add `multi_select` renderer** to `FlapSpecificFields.tsx` — the type exists but there's no UI for it
2. **Add 7 missing field configs** to `flapFieldConfig.ts` — properties exist on `FlapSpecificDetails` in `case.ts` but have no config entry, so they never render
3. **Fix `FLAP_ELEVATION_PLANES` typing** — use `ElevationPlane[]` instead of `string[]`

---

## Step 1: Add `MultiSelectField` to `client/components/FlapSpecificFields.tsx`

### 1a. Add `multi_select` case to the switch statement

In the `visibleFields.map` switch block, add this case **between the `"select"` case and the `"boolean"` case**:

```tsx
          case "multi_select":
            return (
              <MultiSelectField
                key={field.key}
                field={field}
                values={(getValue(field.key) as string[]) ?? []}
                onToggle={(v) => {
                  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                  const current = (getValue(field.key) as string[]) ?? [];
                  const next = current.includes(v)
                    ? current.filter((x) => x !== v)
                    : [...current, v];
                  setValue(field.key, next.length > 0 ? next : undefined);
                }}
              />
            );
```

### 1b. Add the `MultiSelectField` sub-component

Add this function **after the existing `BooleanField` function** (around line 189, before the `const styles = StyleSheet.create` block):

```tsx
function MultiSelectField({
  field,
  values,
  onToggle,
}: {
  field: FlapFieldDefinition;
  values: string[];
  onToggle: (value: string) => void;
}) {
  const { theme } = useTheme();

  return (
    <View style={styles.fieldContainer}>
      <ThemedText style={[styles.fieldLabel, { color: theme.textSecondary }]}>
        {field.label}{field.required ? " *" : ""} (select all that apply)
      </ThemedText>
      {field.hint ? (
        <ThemedText style={[styles.fieldHint, { color: theme.textSecondary }]}>
          {field.hint}
        </ThemedText>
      ) : null}
      <View style={styles.optionsWrap}>
        {(field.options || []).map((option) => {
          const selected = values.includes(option.value);
          return (
            <Pressable
              key={option.value}
              style={[
                styles.optionChip,
                {
                  backgroundColor: selected
                    ? theme.link + "20"
                    : theme.backgroundDefault,
                  borderColor: selected ? theme.link : theme.border,
                },
              ]}
              onPress={() => onToggle(option.value)}
            >
              <ThemedText
                style={[
                  styles.optionText,
                  {
                    color: selected ? theme.link : theme.text,
                    fontWeight: selected ? "600" : "400",
                  },
                ]}
              >
                {selected ? "✓ " : ""}{option.label}
              </ThemedText>
            </Pressable>
          );
        })}
      </View>
    </View>
  );
}
```

No new styles needed — `MultiSelectField` reuses the same `fieldContainer`, `fieldLabel`, `fieldHint`, `optionsWrap`, `optionChip`, and `optionText` styles already defined.

---

## Step 2: Add 7 missing field configs to `client/data/flapFieldConfig.ts`

These properties already exist on `FlapSpecificDetails` in `case.ts` but have no corresponding config entry, so they never appear in the UI. Add each one at the **end** of its respective flap's config array (before the closing `]`).

### 2a. Add to `radial_forearm` config (after the existing `rfffSkinPaddleCount` entry):

```typescript
    {
      key: "rfffBrachioradialisIncluded",
      label: "Brachioradialis Included",
      type: "boolean",
    },
    {
      key: "rfffFcrIncluded",
      label: "FCR Tendon Included",
      type: "boolean",
    },
```

### 2b. Add to `scip` config (after the existing `scipSensate` entry):

```typescript
    {
      key: "scipChimericComponents",
      label: "Chimeric Components",
      type: "multi_select",
      options: [
        { value: "external_oblique_fascia", label: "External oblique fascia" },
        { value: "sartorius", label: "Sartorius muscle" },
        { value: "iliac_bone", label: "Iliac bone (deep branch)" },
        { value: "lymph_nodes", label: "Inguinal lymph nodes" },
      ],
    },
```

### 2c. Add to `latissimus_dorsi` config (after the existing `ldExtensionArea` entry):

```typescript
    {
      key: "ldNerveTarget",
      label: "Nerve Coaptation Target (if functional)",
      type: "select",
      showWhen: { key: "ldNerveStatus", values: ["preserved"] },
      options: [
        { value: "cfng", label: "Cross-face nerve graft" },
        { value: "masseteric", label: "Masseteric nerve" },
        { value: "dual", label: "Dual (masseteric + CFNG)" },
        { value: "hypoglossal", label: "Hypoglossal" },
      ],
    },
    {
      key: "ldChimericComponents",
      label: "Chimeric Components",
      type: "multi_select",
      options: [
        { value: "serratus_anterior", label: "Serratus anterior" },
        { value: "scapular_tip_bone", label: "Scapular tip bone" },
        { value: "parascapular_skin", label: "Parascapular skin" },
        { value: "rib", label: "Rib" },
      ],
    },
```

### 2d. Add to `tdap` config (after the existing `tdapSkinPaddle` entry):

```typescript
    {
      key: "tdapChimericComponents",
      label: "Chimeric Components",
      type: "multi_select",
      options: [
        { value: "ld_cuff", label: "LD muscle cuff" },
        { value: "serratus_anterior", label: "Serratus anterior" },
        { value: "scapular_bone", label: "Scapular bone" },
      ],
    },
```

### 2e. Add to `scapular` config (after the existing `scapularChimericCount` entry):

```typescript
    {
      key: "scapularMusclesIncluded",
      label: "Muscles Included",
      type: "multi_select",
      options: [
        { value: "teres_major", label: "Teres major" },
        { value: "serratus_anterior", label: "Serratus anterior" },
        { value: "latissimus_dorsi", label: "Latissimus dorsi" },
      ],
    },
```

### 2f. Also add the same `scapularMusclesIncluded` entry to `parascapular` config (after its `scapularChimericCount` entry):

```typescript
    {
      key: "scapularMusclesIncluded",
      label: "Muscles Included",
      type: "multi_select",
      options: [
        { value: "teres_major", label: "Teres major" },
        { value: "serratus_anterior", label: "Serratus anterior" },
        { value: "latissimus_dorsi", label: "Latissimus dorsi" },
      ],
    },
```

---

## Step 3: Fix `FLAP_ELEVATION_PLANES` typing in `client/data/flapFieldConfig.ts`

At the top of the file, update the import to also import `ElevationPlane`:

```typescript
import type { FreeFlap, ElevationPlane } from "@/types/case";
```

Then change the `FLAP_ELEVATION_PLANES` declaration from:

```typescript
export const FLAP_ELEVATION_PLANES: Partial<Record<FreeFlap, string[]>> = {
```

to:

```typescript
export const FLAP_ELEVATION_PLANES: Partial<Record<FreeFlap, ElevationPlane[]>> = {
```

No value changes needed — all the string values already match `ElevationPlane` union members.

---

## Verification Checklist

After making these changes, verify:

- [ ] **RFFF**: selecting any flap composition shows brachioradialis + FCR toggle fields at the bottom
- [ ] **SCIP**: chimeric components shows as multi-select chips (can select multiple)
- [ ] **LD**: setting nerve status to "Preserved" reveals nerve coaptation target dropdown; chimeric components renders as multi-select
- [ ] **TDAP**: chimeric components renders as multi-select after the skin paddle field
- [ ] **Scapular** and **Parascapular**: muscles included renders as multi-select after chimeric count
- [ ] **Multi-select deselect**: tapping a selected chip removes it (checkmark disappears)
- [ ] **Existing flaps still work**: ALT, DIEP, Gracilis, Fibula all render correctly — no regressions
- [ ] **TypeScript compiles** with no errors (the `ElevationPlane` import and type change should pass cleanly)