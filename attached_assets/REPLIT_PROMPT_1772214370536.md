# REPLIT AGENT PROMPT — Hand Surgery UX Overhaul

## Context
Read the full implementation spec in `IMPLEMENTATION_SPEC.md` (uploaded alongside this prompt). This prompt summarizes the key actions. The spec has all the detail, edge cases, data structures, and pseudo-code.

## What to build

Three interconnected features for the Hand Surgery case entry flow:

### 1. Collapse Diagnosis After Selection (ALL specialties)

In `DiagnosisPicker.tsx` (or wherever the diagnosis subcategory tabs + list are rendered within `DiagnosisGroupEditor.tsx`):

- When a diagnosis is selected, collapse the full picklist (tabs, search, list) down to a compact card showing just the selected diagnosis name + SNOMED code + an ✕ button to re-expand
- Create a new `SelectedDiagnosisCard.tsx` component for this compact display
- When ✕ is tapped, re-expand the full picker
- This applies to ALL specialties, not just hand surgery
- Staging fields should still render below the collapsed card
- Works for both Tier 1 (picklist) and Tier 2 (SNOMED free search) diagnoses

### 2. Strict Procedure Filtering (ALL specialties)

In the procedure section of `DiagnosisGroupEditor.tsx`:

- When a diagnosis is selected AND it has `suggestedProcedures.length > 0`, ONLY show the suggested procedures
- Hide the full procedure picker (subcategory tabs, browse, search)
- Add a "Show all procedures" text link below the suggestions that expands the full picker when tapped
- The suggested procedures should render as tappable cards showing procedure name + selection state (filled/empty circle)
- If diagnosis has no suggestions, show the full procedure picker as before

### 3. Trauma/Elective Branching (Hand Surgery ONLY)

This is the biggest change. When `specialty === "hand_surgery"`:

**A) Add a Case Type selector** (segmented control, same style as the urgency selector) at the top of the diagnosis section:
- Options: "Trauma" / "Elective"
- Neither pre-selected — surgeon must choose
- Auto-sets the urgency/case tag (Trauma → "trauma" tag, Elective → "elective" tag)

**B) Trauma pathway** (when "Trauma" selected):
- Show optional AO Fracture Classification section (collapsed by default, tap to expand)
  - Uses the existing AO picker component
  - When AO code is completed, auto-resolve to a diagnosis using the new `aoToDiagnosisMapping.ts` (see new file below)
  - Auto-set the diagnosis and collapse it (Feature 1)
- Show Injured Structures picker (existing component, already visible for hand trauma)
- Show diagnosis picker filtered to `clinicalGroup === "trauma"` diagnoses only
  - If AO already set the diagnosis, show the collapsed card instead
- Show filtered procedures (Feature 2)

**C) Elective pathway** (when "Elective" selected):
- Show diagnosis picker filtered to `clinicalGroup !== "trauma"` (elective, oncological, reconstructive, congenital)
- NO AO classifier, NO injured structures picker
- Show filtered procedures (Feature 2)
- Subcategories shown: Compression Neuropathies, Dupuytren's, Joint & Degenerative, Tendon (Elective), Other / Tumours

## New file to create

### `client/lib/aoToDiagnosisMapping.ts`

Create this new file with the content from the uploaded `aoToDiagnosisMapping.ts`. This provides:
- `AO_DIAGNOSIS_MAPPINGS` — maps AO bone family codes to diagnosis picklist IDs
- `resolveAOToDiagnosis()` — resolves AO params to a diagnosis ID + procedure hints
- `applyProcedureHints()` — modifies procedure suggestion defaults based on AO classification
- `getAOMappableDiagnosisIds()` — lists all AO-mappable diagnosis IDs

The key mappings:
- Scaphoid (72) → `hand_dx_scaphoid_fracture`
- Metacarpal (77) → `hand_dx_metacarpal_fracture` (with Bennett's/Rolando's refinements for thumb)
- Phalanx (78) → `hand_dx_phalanx_fracture`
- Other carpals → `hand_dx_carpal_fracture_other` (NEW — add if missing)
- Crush (79) → `hand_dx_crush_injury` (add if missing)

## Data changes needed

### In `handSurgeryDiagnoses.ts`:

1. **Reclassify** `hand_dx_scaphoid_nonunion`: change `clinicalGroup` from `"trauma"` to `"reconstructive"` (it's elective surgery for previous trauma)
2. **Reclassify** `hand_dx_malunion`: change `clinicalGroup` from `"trauma"` to `"reconstructive"`
3. **Add** `hand_dx_carpal_fracture_other` if it doesn't exist (for lunate, capitate, hamate, trapezium, triquetrum, pisiform fractures):
   - SNOMED CT: 33173003 (Fracture of carpal bone)
   - clinicalGroup: "trauma"
   - subcategory: "Fractures"
   - suggestedProcedures: carpal ORIF + CRIF

### In `procedurePicklist.ts`:

Add these procedure entries if they don't exist (in the Hand Surgery fracture section):
1. `hand_fx_phalanx_crif_ccs` — "Phalangeal fracture CRIF (headless compression screw)"
2. `hand_fx_phalanx_exfix` — "Phalangeal fracture external fixation"
3. `hand_fx_metacarpal_crif_ccs` — "Metacarpal fracture CRIF (headless compression screw)" 
4. `hand_fx_metacarpal_exfix` — "Metacarpal fracture external fixation"
5. `hand_fx_carpal_orif` — "Carpal fracture ORIF" (if needed for the new other-carpal diagnosis)
6. `hand_fx_carpal_crif` — "Carpal fracture CRIF (K-wires)"

Then update the `suggestedProcedures` arrays in the relevant hand surgery diagnoses to include CCS and exfix options.

### SNOMED CT codes for new procedures
Use `VERIFY` placeholder for now — I'll verify these separately against the SNOMED CT browser.

## DiagnosisPicker filtering

Add a new optional prop to the diagnosis picker component:

```typescript
clinicalGroupFilter?: "trauma" | "non-trauma";
```

When set:
- `"trauma"`: only show diagnoses where `clinicalGroup === "trauma"`
- `"non-trauma"`: only show diagnoses where `clinicalGroup !== "trauma"` (includes elective, oncological, reconstructive, congenital)
- `undefined`: show all (default, for non-hand specialties)

Also filter the subcategory tabs — only show tabs that have at least one diagnosis matching the filter.

## Critical constraints

1. **No regressions** — other specialties must continue working identically
2. **No database/schema changes** — all new state is UI-only
3. **Existing case loading** — when editing an existing case, infer the case type from the diagnosis's clinicalGroup and set the UI accordingly
4. **Multi-group cases** — the case type selector is per diagnosis group, not per case
5. **Procedure-first flow** — if surgeon adds a procedure before selecting diagnosis, the case type selector can be bypassed
6. **Match existing styling** — use the same dark theme, component patterns, and spacing as the rest of the app

## Order of implementation

1. First: Feature 1 (Collapse diagnosis) — affects all specialties, foundational
2. Second: Feature 2 (Procedure filtering) — builds on Feature 1
3. Third: Feature 3 (Trauma/Elective branching) — hand surgery specific, uses both 1 and 2
4. Last: Data additions (new procedures, new diagnoses, reclassifications)

Test after each feature before moving to the next.
