# Replit Agent Prompt: Free Flap Modifications Module Update

## Summary

Update the free flap clinical details module to add **flap-type-specific conditional fields** for all 16 free flaps. Currently, when a surgeon selects a flap type (e.g., DIEP, ALT, fibula), they see only generic fields (elevation plane, perforator count, dimensions). After this update, each flap type will render its own clinically meaningful parameters — the fields that define the actual procedure performed.

**Architectural approach**: Store flap-specific data in a new `flapSpecificDetails` property on the existing `FreeFlapDetails` interface. This is a nested JSON object — no database schema changes needed since `clinicalDetails` is already stored as JSON on each case procedure.

---

## Files to Modify

| File | Action |
|------|--------|
| `client/types/case.ts` | Add flap-specific type definitions, expand `ElevationPlane`, update `FreeFlapDetails` |
| `client/data/flapFieldConfig.ts` | **CREATE** — Configuration registry mapping each flap type to its conditional fields |
| `client/components/FlapSpecificFields.tsx` | **CREATE** — Renders flap-type-specific form fields conditionally |
| `client/components/FreeFlapPicker.tsx` | Update elevation plane options per flap type |
| `client/components/ProcedureClinicalDetails.tsx` | Integrate `FlapSpecificFields` into the free flap clinical form |

---

## Step 1: Update `client/types/case.ts`

### 1a. Expand `ElevationPlane` type

Replace the existing `ElevationPlane` type and labels:

```typescript
export type ElevationPlane = 
  | "subfascial" 
  | "suprafascial" 
  | "epifascial" 
  | "thin"          // At superficial fascial plane ~4-11mm
  | "superthin"     // Above superficial fascia ~2-4mm
  | "ultrathin"     // Most superficial adipocutaneous <5mm
  | "subdermal";    // Pure skin

export const ELEVATION_PLANE_LABELS: Record<ElevationPlane, string> = {
  subfascial: "Subfascial",
  suprafascial: "Suprafascial",
  epifascial: "Epifascial",
  thin: "Thin (~4–11 mm)",
  superthin: "Superthin (~2–4 mm)",
  ultrathin: "Ultrathin (<5 mm)",
  subdermal: "Subdermal / Pure Skin",
};
```

### 1b. Add flap-specific sub-types

Add these new type definitions (place them after the `ElevationPlane` definitions):

```typescript
// ── ALT-specific ──
export type ALTPerforatorType = "musculocutaneous" | "septocutaneous" | "oblique_branch";
export type ALTPedicleSource = "type_i_descending" | "type_ii_transverse" | "type_iii_profunda";
export type ALTPerforatorLocation = "a_proximal" | "b_midpoint" | "c_distal";
export type ALTTissueComposition = "fasciocutaneous" | "myocutaneous" | "chimeric" | "adipofascial" | "fascial_only" | "de_epithelialized";
export type ALTExtendedVariant = "standard" | "extended" | "bipedicled" | "conjoined_alt_tfl";

// ── DIEP-specific ──
export type DIEPPerfusionZones = "zone_i_only" | "zone_i_iii" | "zone_i_ii_iii" | "zone_i_ii_iii_iv";
export type DIEPPerforatorRow = "medial" | "lateral" | "both";
export type MSTRAMClassification = "ms_0" | "ms_1" | "ms_2" | "ms_3";
export type GillDIEPSubtype = "diep_1" | "diep_2" | "diep_3";
export type DIEPFlapConfiguration = "standard_unilateral" | "hemi_diep" | "stacked" | "conjoined_double_pedicle" | "bipedicled";
export type DIEPVenousSupercharge = "none" | "siev_ipsilateral" | "siev_contralateral" | "bipedicled" | "turbocharged";
export type DIEPFlapExtent = "hemi_diep" | "full_diep";

// ── SIEA-specific ──
export type SIEAVesselStatus = "present_adequate" | "present_inadequate" | "absent";
export type SIEAOriginPattern = "independent" | "common_trunk_scia" | "absent";
export type SIEAFlapExtent = "hemi_abdominal" | "full_abdominal";

// ── Gracilis-specific ──
export type GracilisTissueComposition = "muscle_only" | "myocutaneous" | "myofasciocutaneous" | "perforator_only";
export type GracilisSkinPaddle = "none" | "transverse_tug" | "vertical" | "oblique_dug" | "l_shaped";
export type GracilisNerveTarget = "cfng" | "masseteric" | "dual" | "hypoglossal" | "spinal_accessory";
export type GracilisCoaptation = "end_to_end" | "end_to_side" | "dual";
export type GracilisHarvestExtent = "complete" | "partial_proximal" | "segmental";

// ── PAP-specific ──
export type PAPSkinPaddle = "transverse_tpap" | "vertical_vpap" | "diagonal_dpap" | "fleur_de_lis" | "s_shaped";
export type PAPPerforatorType = "musculocutaneous" | "septocutaneous";
export type PAPStacking = "single" | "stacked_bilateral" | "stacked_diep_pap" | "tug_pap";

// ── SCIP-specific ──
export type SCIPPedicleBranch = "superficial_scias" | "deep_sciad" | "both";
export type SCIPThickness = "standard" | "thin" | "superthin" | "subdermal";
export type SCIPLymphatic = "none" | "vlnt" | "vlvt" | "lyst";
export type SCIPTissueComposition = "cutaneous" | "adipofascial" | "fasciocutaneous";

// ── LD-specific ──
export type LDHarvestExtent = "tdap" | "msld_i" | "msld_ii" | "msld_iii" | "complete_ld" | "extended_ld";
export type LDTissueComposition = "muscle_only" | "myocutaneous" | "fasciocutaneous_tdap" | "osteomyocutaneous_rib" | "osteomyocutaneous_scapular_tip";
export type LDNerveStatus = "divided" | "preserved";
export type LDExtensionArea = "scapular_fat" | "parascapular_fat" | "lumbar_fat" | "combined";
export type LDSkinPaddle = "transverse" | "vertical" | "oblique" | "fleur_de_lis" | "none";
export type LDMuscleBranch = "whole_muscle" | "descending" | "transverse" | "bilobed";

// ── TDAP-specific ──
export type TDAPTissueComposition = "fasciocutaneous" | "adipofascial" | "chimeric_ld_cuff" | "chimeric_serratus";
export type TDAPPerforatorSource = "descending_branch" | "transverse_branch" | "main_tda_trunk";
export type TDAPThinning = "standard" | "primary_thinned" | "superthin";
export type TDAPConversion = "completed_tdap" | "converted_msld" | "converted_full_ld";
export type TDAPSkinPaddle = "transverse" | "vertical" | "oblique" | "propeller";

// ── Fibula-specific ──
export type FibulaTissueComposition = "bone_only" | "osteocutaneous" | "osteomyocutaneous";
export type FibulaSkinPaddleType = "type_a_septocutaneous" | "type_b_septo_musculo" | "type_c_musculocutaneous" | "type_d_popliteal";
export type FibulaBarrel = "single" | "double" | "hybrid_1_2_1" | "biaxial_double";
export type FibulaPlanningMethod = "freehand" | "vsp_models" | "vsp_cutting_guides" | "vsp_psi" | "in_house_vsp";
export type FibulaFixation = "reconstruction_plate" | "miniplates" | "patient_specific_plate" | "combination";
export type FibulaDentalImplant = "immediate" | "delayed" | "not_planned";
export type FibulaReconSite = "mandible" | "maxilla" | "long_bone";

// ── Scapular-specific ──
export type ScapularSkinPaddle = "scapular" | "parascapular" | "both_boomerang" | "none";
export type ScapularBoneComponent = "none" | "lateral_border" | "scapular_tip" | "both";
export type ScapularVascularPedicle = "csa_only" | "subscapular_extended" | "tda_for_tip";

// ── SGAP/IGAP-specific ──
export type GAPSubtype = "sgap" | "igap" | "sc_gap";
export type SGAPSkinPaddle = "oblique" | "transverse" | "modified_lateral";
export type IGAPSkinPaddle = "in_the_crease" | "oblique" | "transverse";
export type GAPPerforatorType = "musculocutaneous" | "septocutaneous";

// ── RFFF-specific ──
export type RFFFTissueComposition = "fasciocutaneous" | "osteocutaneous" | "adipofascial" | "composite_palmaris" | "composite_neuroteno";
export type RFFFSensateNerve = "non_sensate" | "labcn" | "mabcn" | "both";
export type RFFFDissectionPlane = "subfascial" | "suprafascial";
export type RFFFVenousDrainage = "venae_comitantes" | "cephalic_vein" | "both";
export type RFFFVariant = "radial" | "ulnar";
export type RFFFConfiguration = "standard" | "folded" | "tubed";

// ── MSAP-specific ──
export type MSAPTissueComposition = "fasciocutaneous" | "adipofascial" | "chimeric_gastrocnemius";
export type MSAPBranchingPattern = "type_i_single" | "type_iia_dual_superior" | "type_iib_dual_inferior" | "type_iii_triple";
export type MSAPPerforatorCourse = "type_1_direct" | "type_2_oblique" | "type_3_tortuous";
export type MSAPSensate = "non_sensate" | "medial_sural_cutaneous" | "sural_nerve";
export type MSAPThinning = "standard" | "thinned";

// ── Serratus-specific ──
export type SerratusTissueComposition = "muscle_only" | "myocutaneous" | "fascia_only" | "osteomuscular" | "osteomyocutaneous";
export type SerratusNerveStatus = "preserved" | "divided";
export type SerratusNerveTarget = "masseteric" | "facial_nerve" | "cfng";
export type SerratusChimeric = "serratus_alone" | "plus_ld" | "plus_ld_rib" | "plus_ld_scapular_bone" | "mega_flap";
```

### 1c. Add `FlapSpecificDetails` interface

Add this after the flap sub-types. This is the master type for all flap-specific data:

```typescript
export interface FlapSpecificDetails {
  // ── ALT ──
  altTissueComposition?: ALTTissueComposition;
  altPerforatorType?: ALTPerforatorType;
  altPedicleSource?: ALTPedicleSource;
  altPerforatorLocation?: ALTPerforatorLocation;
  altNumberOfSkinPaddles?: number;
  altFlowThrough?: boolean;
  altSensate?: boolean;
  altPrimaryThinning?: boolean;
  altExtendedVariant?: ALTExtendedVariant;

  // ── DIEP ──
  diepPerfusionZones?: DIEPPerfusionZones;
  diepPerforatorRow?: DIEPPerforatorRow;
  diepMSTRAM?: MSTRAMClassification;
  diepGillSubtype?: GillDIEPSubtype;
  diepFlapConfiguration?: DIEPFlapConfiguration;
  diepVenousSupercharge?: DIEPVenousSupercharge;
  diepMotorNervePreservation?: string;
  diepSensoryNeurotization?: boolean;
  diepFlapExtent?: DIEPFlapExtent;

  // ── SIEA ──
  sieaVesselStatus?: SIEAVesselStatus;
  sieaArterialDiameterMm?: number;
  sieaOriginPattern?: SIEAOriginPattern;
  sieaConvertedToDiep?: boolean;
  sieaFlapExtent?: SIEAFlapExtent;
  sieaConjoinedWithDiep?: boolean;

  // ── Gracilis ──
  gracilisTissueComposition?: GracilisTissueComposition;
  gracilisSkinPaddle?: GracilisSkinPaddle;
  gracilisFunctionalTransfer?: boolean;
  gracilisNerveTarget?: GracilisNerveTarget;
  gracilisCoaptation?: GracilisCoaptation;
  gracilisCFNGStaging?: "single_stage" | "two_stage";
  gracilisHarvestExtent?: GracilisHarvestExtent;

  // ── PAP ──
  papSkinPaddle?: PAPSkinPaddle;
  papPerforatorType?: PAPPerforatorType;
  papSensate?: boolean;
  papSensateNerve?: string;
  papStacking?: PAPStacking;

  // ── SCIP ──
  scipPedicleBranch?: SCIPPedicleBranch;
  scipThickness?: SCIPThickness;
  scipLymphatic?: SCIPLymphatic;
  scipTissueComposition?: SCIPTissueComposition;
  scipBoneIncluded?: boolean;
  scipSensate?: boolean;
  scipChimericComponents?: string[];

  // ── LD ──
  ldHarvestExtent?: LDHarvestExtent;
  ldTissueComposition?: LDTissueComposition;
  ldNerveStatus?: LDNerveStatus;
  ldNerveTarget?: string;
  ldExtensionArea?: LDExtensionArea;
  ldSkinPaddle?: LDSkinPaddle;
  ldMuscleBranch?: LDMuscleBranch;
  ldChimericComponents?: string[];

  // ── TDAP ──
  tdapTissueComposition?: TDAPTissueComposition;
  tdapPerforatorSource?: TDAPPerforatorSource;
  tdapThinning?: TDAPThinning;
  tdapConversion?: TDAPConversion;
  tdapSkinPaddle?: TDAPSkinPaddle;
  tdapChimericComponents?: string[];

  // ── Fibula ──
  fibulaTissueComposition?: FibulaTissueComposition;
  fibulaSkinPaddleType?: FibulaSkinPaddleType;
  fibulaOsteotomyCount?: number;
  fibulaBarrel?: FibulaBarrel;
  fibulaPlanningMethod?: FibulaPlanningMethod;
  fibulaFixation?: FibulaFixation;
  fibulaBoneLengthCm?: number;
  fibulaSkinPaddleCount?: number;
  fibulaDentalImplant?: FibulaDentalImplant;
  fibulaReconSite?: FibulaReconSite;

  // ── Scapular ──
  scapularSkinPaddle?: ScapularSkinPaddle;
  scapularBoneComponent?: ScapularBoneComponent;
  scapularVascularPedicle?: ScapularVascularPedicle;
  scapularMusclesIncluded?: string[];
  scapularChimericCount?: number;

  // ── SGAP/IGAP ──
  gapSubtype?: GAPSubtype;
  sgapSkinPaddle?: SGAPSkinPaddle;
  igapSkinPaddle?: IGAPSkinPaddle;
  gapPerforatorType?: GAPPerforatorType;
  gapSensate?: boolean;
  gapStacked?: boolean;
  gapPositionChange?: boolean;

  // ── RFFF ──
  rfffTissueComposition?: RFFFTissueComposition;
  rfffSensateNerve?: RFFFSensateNerve;
  rfffDissectionPlane?: RFFFDissectionPlane;
  rfffPalmarisIncluded?: "yes" | "no" | "absent";
  rfffBrachioradialisIncluded?: boolean;
  rfffFcrIncluded?: boolean;
  rfffVenousDrainage?: RFFFVenousDrainage;
  rfffBoneSegmentCm?: number;
  rfffProphylacticPlating?: boolean;
  rfffVariant?: RFFFVariant;
  rfffConfiguration?: RFFFConfiguration;
  rfffSkinPaddleCount?: number;

  // ── MSAP ──
  msapTissueComposition?: MSAPTissueComposition;
  msapBranchingPattern?: MSAPBranchingPattern;
  msapPerforatorCourse?: MSAPPerforatorCourse;
  msapSensate?: MSAPSensate;
  msapDominantBranch?: "lateral" | "medial";
  msapChimericMuscle?: "none" | "medial_gastrocnemius";
  msapThinning?: MSAPThinning;

  // ── Serratus ──
  serratusSlipCount?: number;
  serratusSpecificSlips?: string;
  serratusTissueComposition?: SerratusTissueComposition;
  serratusRibIncluded?: boolean;
  serratusRibNumbers?: string;
  serratusNerveStatus?: SerratusNerveStatus;
  serratusNerveTarget?: SerratusNerveTarget;
  serratusChimeric?: SerratusChimeric;
}
```

### 1d. Update `FreeFlapDetails` interface

Add the `flapSpecificDetails` property to the existing `FreeFlapDetails` interface:

```typescript
export interface FreeFlapDetails {
  harvestSide: HarvestSide;
  indication: Indication;
  flapType?: FreeFlap;
  flapSnomedCode?: string;
  flapSnomedDisplay?: string;
  flapCommonName?: string;
  composition?: string;
  harvestTechnique?: string;
  skinIsland?: boolean;
  recipientSite?: string;
  recipientSiteRegion?: AnatomicalRegion;
  recipientSiteSnomedCode?: string;
  recipientSiteSnomedDisplay?: string;
  ischemiaTimeMinutes?: number;
  flapWidthCm?: number;
  flapLengthCm?: number;
  perforatorCount?: 1 | 2 | 3;
  elevationPlane?: ElevationPlane;
  isFlowThrough?: boolean;
  anastomoses: AnastomosisEntry[];
  flapDisplayName?: string;
  recipientArteryName?: string;
  recipientVeinName?: string;
  anastomosisType?: AnastomosisType;
  couplerSizeMm?: number;
  // NEW — flap-specific conditional fields
  flapSpecificDetails?: FlapSpecificDetails;
}
```

### 1e. Add `FreeFlap` value for `scapular`

The current `FreeFlap` union already has `parascapular`. Add `scapular` as a separate value since the reference document treats scapular/parascapular as a single system. Rename `parascapular` to `scapular_system` to reflect this:

Actually — **do NOT rename** `parascapular` (would break existing data). Instead, add `scapular` as a new value:

```typescript
export type FreeFlap = 
  | "alt"
  | "latissimus_dorsi" 
  | "gracilis"
  | "tug"
  | "scip"
  | "siea"
  | "radial_forearm"
  | "fibula"
  | "diep"
  | "medial_sural"
  | "sgap"
  | "igap"
  | "pap"
  | "tdap"
  | "parascapular"
  | "scapular"          // NEW
  | "serratus_anterior"
  | "other";

// Update the labels map too:
export const FREE_FLAP_LABELS: Record<FreeFlap, string> = {
  alt: "ALT (Anterolateral Thigh)",
  latissimus_dorsi: "Latissimus Dorsi (LD)",
  gracilis: "Gracilis",
  tug: "TUG (Transverse Upper Gracilis)",
  scip: "SCIP (Superficial Circumflex Iliac Perforator)",
  siea: "SIEA (Superficial Inferior Epigastric Artery)",
  radial_forearm: "RFFF (Radial Forearm)",
  fibula: "Fibula (Osteocutaneous)",
  diep: "DIEP",
  medial_sural: "MSAP (Medial Sural Artery Perforator)",
  sgap: "SGAP (Superior Gluteal Artery Perforator)",
  igap: "IGAP (Inferior Gluteal Artery Perforator)",
  pap: "PAP (Profunda Artery Perforator)",
  tdap: "TDAP (Thoracodorsal Artery Perforator)",
  parascapular: "Parascapular",
  scapular: "Scapular System",            // NEW
  serratus_anterior: "Serratus Anterior",
  other: "Other",
};
```

Also add the SNOMED mapping for scapular:

```typescript
// Add to FLAP_SNOMED_MAP:
scapular: { code: "234303001", display: "Free scapular flap (procedure)" },
```

And add to `DEFAULT_DONOR_VESSELS` in `ProcedureClinicalDetails.tsx`:

```typescript
scapular: {
  artery: "Circumflex scapular artery",
  vein: "Circumflex scapular vein",
},
```

---

## Step 2: Create `client/data/flapFieldConfig.ts`

This is the configuration registry. It defines which fields appear for each flap type, their labels, and their options. The UI component reads this config to render fields dynamically.

Create the file `client/data/flapFieldConfig.ts` with the following content:

```typescript
/**
 * Flap-specific field configuration registry.
 * 
 * Each flap type maps to an array of field definitions that render conditionally
 * when that flap is selected. Fields are ordered by surgical decision sequence:
 * tissue composition → elevation/plane → perforator anatomy → special configs → adjuncts.
 * 
 * Fields marked `required: true` are the "defining parameter" for that flap.
 */

import type { FreeFlap } from "@/types/case";

export type FlapFieldType = "select" | "boolean" | "number" | "text" | "multi_select";

export interface FlapFieldOption {
  value: string;
  label: string;
}

export interface FlapFieldDefinition {
  /** Property key on FlapSpecificDetails (e.g., "altTissueComposition") */
  key: string;
  /** Display label shown in the UI */
  label: string;
  /** Field type determining which UI control renders */
  type: FlapFieldType;
  /** Options for select/multi_select fields */
  options?: FlapFieldOption[];
  /** Whether this is the flap's defining parameter */
  required?: boolean;
  /** Hint text shown below the field */
  hint?: string;
  /** Unit suffix for number fields */
  unit?: string;
  /** Placeholder for number/text fields */
  placeholder?: string;
  /** Only show this field when another field has a specific value */
  showWhen?: { key: string; values: string[] };
}

export const FLAP_FIELD_CONFIG: Partial<Record<FreeFlap, FlapFieldDefinition[]>> = {

  // ════════════════════════════════════════════
  //  ALT (Anterolateral Thigh)
  // ════════════════════════════════════════════
  alt: [
    {
      key: "altTissueComposition",
      label: "Tissue Composition",
      type: "select",
      required: true,
      options: [
        { value: "fasciocutaneous", label: "Fasciocutaneous" },
        { value: "myocutaneous", label: "Myocutaneous (VL cuff)" },
        { value: "chimeric", label: "Chimeric (separate paddles)" },
        { value: "adipofascial", label: "Adipofascial (no skin)" },
        { value: "fascial_only", label: "Fascial only" },
        { value: "de_epithelialized", label: "De-epithelialized" },
      ],
    },
    {
      key: "altPerforatorType",
      label: "Perforator Type",
      type: "select",
      required: true,
      options: [
        { value: "musculocutaneous", label: "Musculocutaneous (~87%)" },
        { value: "septocutaneous", label: "Septocutaneous (~13%)" },
        { value: "oblique_branch", label: "Oblique branch (~4%)" },
      ],
    },
    {
      key: "altPedicleSource",
      label: "Pedicle Source Vessel (Shieh)",
      type: "select",
      options: [
        { value: "type_i_descending", label: "Type I — Descending branch LCFA (~90%)" },
        { value: "type_ii_transverse", label: "Type II — Transverse branch (~4–9%)" },
        { value: "type_iii_profunda", label: "Type III — Direct from profunda (~4–6%)" },
      ],
    },
    {
      key: "altPerforatorLocation",
      label: "Perforator Location (Yu ABC)",
      type: "select",
      options: [
        { value: "a_proximal", label: "A — Proximal (~5 cm above midpoint)" },
        { value: "b_midpoint", label: "B — Midpoint (most consistent)" },
        { value: "c_distal", label: "C — Distal (~5 cm below)" },
      ],
    },
    {
      key: "altNumberOfSkinPaddles",
      label: "Number of Skin Paddles",
      type: "select",
      options: [
        { value: "1", label: "1" },
        { value: "2", label: "2 (bipaddle)" },
        { value: "3", label: "3+" },
      ],
    },
    {
      key: "altFlowThrough",
      label: "Flow-through Design",
      type: "boolean",
    },
    {
      key: "altSensate",
      label: "Sensate (LFCN included)",
      type: "boolean",
    },
    {
      key: "altPrimaryThinning",
      label: "Primary Thinning Performed",
      type: "boolean",
    },
    {
      key: "altExtendedVariant",
      label: "Extended Variant",
      type: "select",
      options: [
        { value: "standard", label: "Standard" },
        { value: "extended", label: "Extended" },
        { value: "bipedicled", label: "Bipedicled" },
        { value: "conjoined_alt_tfl", label: "Conjoined ALT+TFL" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  DIEP
  // ════════════════════════════════════════════
  diep: [
    {
      key: "diepPerforatorRow",
      label: "Perforator Row",
      type: "select",
      required: true,
      options: [
        { value: "medial", label: "Medial row (longer pedicle)" },
        { value: "lateral", label: "Lateral row (shorter pedicle)" },
        { value: "both", label: "Both rows" },
      ],
    },
    {
      key: "diepMSTRAM",
      label: "MS-TRAM Classification (Nahabedian)",
      type: "select",
      required: true,
      options: [
        { value: "ms_0", label: "MS-0 — Full rectus harvested" },
        { value: "ms_1", label: "MS-1 — Lateral muscle preserved" },
        { value: "ms_2", label: "MS-2 — Medial + lateral preserved" },
        { value: "ms_3", label: "MS-3 — Entire rectus preserved (true DIEP)" },
      ],
    },
    {
      key: "diepPerfusionZones",
      label: "Perfusion Zones Included",
      type: "select",
      options: [
        { value: "zone_i_only", label: "Zone I only" },
        { value: "zone_i_iii", label: "Zones I + III" },
        { value: "zone_i_ii_iii", label: "Zones I + II + III" },
        { value: "zone_i_ii_iii_iv", label: "Zones I + II + III + IV" },
      ],
    },
    {
      key: "diepGillSubtype",
      label: "Gill DIEP Sub-classification",
      type: "select",
      options: [
        { value: "diep_1", label: "DIEP-1 — No muscle/nerve sacrifice" },
        { value: "diep_2", label: "DIEP-2 — Segmental nerve sacrifice" },
        { value: "diep_3", label: "DIEP-3 — Both rows, central muscle" },
      ],
    },
    {
      key: "diepFlapConfiguration",
      label: "Flap Configuration",
      type: "select",
      options: [
        { value: "standard_unilateral", label: "Standard unilateral" },
        { value: "hemi_diep", label: "Hemi-DIEP (ipsilateral only)" },
        { value: "stacked", label: "Stacked (bilateral → unilateral breast)" },
        { value: "conjoined_double_pedicle", label: "Conjoined double-pedicle" },
        { value: "bipedicled", label: "Bipedicled (both DIEAs)" },
      ],
    },
    {
      key: "diepVenousSupercharge",
      label: "Venous Supercharging",
      type: "select",
      options: [
        { value: "none", label: "None" },
        { value: "siev_ipsilateral", label: "SIEV ipsilateral" },
        { value: "siev_contralateral", label: "SIEV contralateral" },
        { value: "bipedicled", label: "Bipedicled" },
        { value: "turbocharged", label: "Turbocharged (DIEA-to-DIEA loop)" },
      ],
    },
    {
      key: "diepFlapExtent",
      label: "Flap Extent",
      type: "select",
      options: [
        { value: "hemi_diep", label: "Hemi-DIEP" },
        { value: "full_diep", label: "Full DIEP" },
      ],
    },
    {
      key: "diepMotorNervePreservation",
      label: "Motor Nerve Preservation",
      type: "select",
      options: [
        { value: "all_preserved", label: "All preserved" },
        { value: "type_1_sacrificed", label: "Type 1 sacrificed" },
        { value: "type_2_preserved", label: "Type 2 preserved" },
        { value: "sacrificed", label: "Sacrificed" },
      ],
    },
    {
      key: "diepSensoryNeurotization",
      label: "Sensory Neurotization",
      type: "boolean",
    },
  ],

  // ════════════════════════════════════════════
  //  SIEA
  // ════════════════════════════════════════════
  siea: [
    {
      key: "sieaVesselStatus",
      label: "SIEA Vessel Status",
      type: "select",
      required: true,
      options: [
        { value: "present_adequate", label: "Present + adequate (≥1.5 mm)" },
        { value: "present_inadequate", label: "Present + inadequate" },
        { value: "absent", label: "Absent" },
      ],
    },
    {
      key: "sieaArterialDiameterMm",
      label: "SIEA Arterial Diameter",
      type: "number",
      unit: "mm",
      placeholder: "1.5",
    },
    {
      key: "sieaOriginPattern",
      label: "SIEA Origin Pattern",
      type: "select",
      options: [
        { value: "independent", label: "Independent" },
        { value: "common_trunk_scia", label: "Common trunk with SCIA" },
        { value: "absent", label: "Absent" },
      ],
    },
    {
      key: "sieaConvertedToDiep",
      label: "Converted to DIEP",
      type: "boolean",
    },
    {
      key: "sieaFlapExtent",
      label: "Flap Extent",
      type: "select",
      options: [
        { value: "hemi_abdominal", label: "Hemi-abdominal" },
        { value: "full_abdominal", label: "Full abdominal" },
      ],
    },
    {
      key: "sieaConjoinedWithDiep",
      label: "Conjoined SIEA+DIEP",
      type: "boolean",
    },
  ],

  // ════════════════════════════════════════════
  //  Gracilis (also covers TUG)
  // ════════════════════════════════════════════
  gracilis: [
    {
      key: "gracilisTissueComposition",
      label: "Tissue Composition",
      type: "select",
      required: true,
      options: [
        { value: "muscle_only", label: "Muscle only" },
        { value: "myocutaneous", label: "Myocutaneous" },
        { value: "myofasciocutaneous", label: "Myofasciocutaneous" },
        { value: "perforator_only", label: "Perforator only (MCFG perforator)" },
      ],
    },
    {
      key: "gracilisSkinPaddle",
      label: "Skin Paddle Orientation",
      type: "select",
      required: true,
      options: [
        { value: "none", label: "None (muscle only)" },
        { value: "transverse_tug", label: "Transverse (TUG/TMG)" },
        { value: "vertical", label: "Vertical (traditional)" },
        { value: "oblique_dug", label: "Oblique/Diagonal (DUG)" },
        { value: "l_shaped", label: "L-shaped" },
      ],
    },
    {
      key: "gracilisFunctionalTransfer",
      label: "Functional Transfer (innervated)",
      type: "boolean",
    },
    {
      key: "gracilisNerveTarget",
      label: "Nerve Coaptation Target",
      type: "select",
      showWhen: { key: "gracilisFunctionalTransfer", values: ["true"] },
      options: [
        { value: "cfng", label: "Cross-face nerve graft (CFNG)" },
        { value: "masseteric", label: "Masseteric nerve" },
        { value: "dual", label: "Dual (masseteric + CFNG)" },
        { value: "hypoglossal", label: "Hypoglossal" },
        { value: "spinal_accessory", label: "Spinal accessory" },
      ],
    },
    {
      key: "gracilisCoaptation",
      label: "Coaptation Configuration",
      type: "select",
      showWhen: { key: "gracilisFunctionalTransfer", values: ["true"] },
      options: [
        { value: "end_to_end", label: "End-to-end" },
        { value: "end_to_side", label: "End-to-side" },
        { value: "dual", label: "Dual" },
      ],
    },
    {
      key: "gracilisCFNGStaging",
      label: "CFNG Staging",
      type: "select",
      showWhen: { key: "gracilisNerveTarget", values: ["cfng", "dual"] },
      options: [
        { value: "single_stage", label: "Single-stage" },
        { value: "two_stage", label: "Two-stage" },
      ],
    },
    {
      key: "gracilisHarvestExtent",
      label: "Muscle Harvest Extent",
      type: "select",
      options: [
        { value: "complete", label: "Complete" },
        { value: "partial_proximal", label: "Partial-proximal" },
        { value: "segmental", label: "Segmental" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  PAP (Profunda Artery Perforator)
  // ════════════════════════════════════════════
  pap: [
    {
      key: "papSkinPaddle",
      label: "Skin Paddle Design",
      type: "select",
      required: true,
      options: [
        { value: "transverse_tpap", label: "Transverse (tPAP)" },
        { value: "vertical_vpap", label: "Vertical (vPAP)" },
        { value: "diagonal_dpap", label: "Diagonal (dPAP)" },
        { value: "fleur_de_lis", label: "Fleur-de-lis" },
        { value: "s_shaped", label: "S-shaped" },
      ],
    },
    {
      key: "papPerforatorType",
      label: "Perforator Type",
      type: "select",
      options: [
        { value: "musculocutaneous", label: "Musculocutaneous (through adductor magnus)" },
        { value: "septocutaneous", label: "Septocutaneous" },
      ],
    },
    {
      key: "papSensate",
      label: "Sensate PAP",
      type: "boolean",
    },
    {
      key: "papSensateNerve",
      label: "Sensory Nerve",
      type: "select",
      showWhen: { key: "papSensate", values: ["true"] },
      options: [
        { value: "pfcn", label: "Posterior femoral cutaneous nerve (PFCN)" },
        { value: "anterior_obturator", label: "Anterior obturator nerve branch" },
      ],
    },
    {
      key: "papStacking",
      label: "Stacking Configuration",
      type: "select",
      options: [
        { value: "single", label: "Single PAP" },
        { value: "stacked_bilateral", label: "Stacked bilateral PAP" },
        { value: "stacked_diep_pap", label: "Stacked DIEP + PAP" },
        { value: "tug_pap", label: "TUGPAP (combined TUG + PAP)" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  SCIP
  // ════════════════════════════════════════════
  scip: [
    {
      key: "scipPedicleBranch",
      label: "Pedicle Branch",
      type: "select",
      required: true,
      hint: "Most important SCIP field — determines pedicle length and angiosome size",
      options: [
        { value: "superficial_scias", label: "Superficial (SCIAs) — shorter pedicle ~6.6 cm" },
        { value: "deep_sciad", label: "Deep (SCIAd) — longer pedicle ~9.1 cm" },
        { value: "both", label: "Both branches" },
      ],
    },
    {
      key: "scipTissueComposition",
      label: "Tissue Composition",
      type: "select",
      options: [
        { value: "cutaneous", label: "Cutaneous" },
        { value: "adipofascial", label: "Adipofascial" },
        { value: "fasciocutaneous", label: "Fasciocutaneous" },
      ],
    },
    {
      key: "scipThickness",
      label: "Thickness Variant",
      type: "select",
      options: [
        { value: "standard", label: "Standard" },
        { value: "thin", label: "Thin" },
        { value: "superthin", label: "Superthin (<5 mm)" },
        { value: "subdermal", label: "Subdermal (pure skin perforator)" },
      ],
    },
    {
      key: "scipLymphatic",
      label: "Lymphatic Component",
      type: "select",
      hint: "Unique to SCIP — critical for lymphoedema reconstruction",
      options: [
        { value: "none", label: "None" },
        { value: "vlnt", label: "VLNT (vascularised lymph node transfer)" },
        { value: "vlvt", label: "VLVT (lymph vessel transfer, no nodes)" },
        { value: "lyst", label: "LYST (lymphatic system transfer)" },
      ],
    },
    {
      key: "scipBoneIncluded",
      label: "Bone Included (iliac crest via deep branch)",
      type: "boolean",
    },
    {
      key: "scipSensate",
      label: "Sensate (T12/L1 cutaneous branches)",
      type: "boolean",
    },
  ],

  // ════════════════════════════════════════════
  //  Latissimus Dorsi
  // ════════════════════════════════════════════
  latissimus_dorsi: [
    {
      key: "ldHarvestExtent",
      label: "Harvest Extent (Hamdi Classification)",
      type: "select",
      required: true,
      options: [
        { value: "tdap", label: "TDAP (no muscle)" },
        { value: "msld_i", label: "MSLD Type I (small cuff, both nerves preserved)" },
        { value: "msld_ii", label: "MSLD Type II (larger strip, nerve preserved)" },
        { value: "msld_iii", label: "MSLD Type III (descending branch sacrificed)" },
        { value: "complete_ld", label: "Complete LD (total muscle harvest)" },
        { value: "extended_ld", label: "Extended LD" },
      ],
    },
    {
      key: "ldTissueComposition",
      label: "Tissue Composition",
      type: "select",
      options: [
        { value: "muscle_only", label: "Muscle only" },
        { value: "myocutaneous", label: "Myocutaneous (with skin paddle)" },
        { value: "fasciocutaneous_tdap", label: "Fasciocutaneous (TDAP)" },
        { value: "osteomyocutaneous_rib", label: "Osteomyocutaneous with rib" },
        { value: "osteomyocutaneous_scapular_tip", label: "Osteomyocutaneous with scapular tip" },
      ],
    },
    {
      key: "ldNerveStatus",
      label: "Thoracodorsal Nerve Status",
      type: "select",
      options: [
        { value: "divided", label: "Divided (denervated)" },
        { value: "preserved", label: "Preserved (functional)" },
      ],
    },
    {
      key: "ldSkinPaddle",
      label: "Skin Paddle Orientation",
      type: "select",
      options: [
        { value: "none", label: "None" },
        { value: "transverse", label: "Transverse (bra line)" },
        { value: "vertical", label: "Vertical" },
        { value: "oblique", label: "Oblique" },
        { value: "fleur_de_lis", label: "Fleur-de-lis" },
      ],
    },
    {
      key: "ldMuscleBranch",
      label: "Muscle Branch Used",
      type: "select",
      options: [
        { value: "whole_muscle", label: "Whole muscle" },
        { value: "descending", label: "Descending branch" },
        { value: "transverse", label: "Transverse branch" },
        { value: "bilobed", label: "Bilobed (both branches, split)" },
      ],
    },
    {
      key: "ldExtensionArea",
      label: "Extended LD — Extension Areas",
      type: "select",
      showWhen: { key: "ldHarvestExtent", values: ["extended_ld"] },
      options: [
        { value: "scapular_fat", label: "Scapular fat pad" },
        { value: "parascapular_fat", label: "Parascapular fat pad" },
        { value: "lumbar_fat", label: "Lumbar fat" },
        { value: "combined", label: "Combined" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  TDAP
  // ════════════════════════════════════════════
  tdap: [
    {
      key: "tdapTissueComposition",
      label: "Tissue Composition",
      type: "select",
      options: [
        { value: "fasciocutaneous", label: "Fasciocutaneous" },
        { value: "adipofascial", label: "Adipofascial" },
        { value: "chimeric_ld_cuff", label: "Chimeric with LD muscle cuff" },
        { value: "chimeric_serratus", label: "Chimeric with serratus anterior" },
      ],
    },
    {
      key: "tdapPerforatorSource",
      label: "Perforator Source Branch",
      type: "select",
      required: true,
      options: [
        { value: "descending_branch", label: "Descending branch (Angrigiani landmark)" },
        { value: "transverse_branch", label: "Transverse branch" },
        { value: "main_tda_trunk", label: "Main TDA trunk" },
      ],
    },
    {
      key: "tdapThinning",
      label: "Thinning",
      type: "select",
      options: [
        { value: "standard", label: "Standard" },
        { value: "primary_thinned", label: "Primary thinned" },
        { value: "superthin", label: "Superthin" },
      ],
    },
    {
      key: "tdapConversion",
      label: "Intraoperative Conversion",
      type: "select",
      required: true,
      hint: "Document if TDAP was converted due to inadequate perforator",
      options: [
        { value: "completed_tdap", label: "Completed as TDAP" },
        { value: "converted_msld", label: "Converted to MSLD" },
        { value: "converted_full_ld", label: "Converted to full LD" },
      ],
    },
    {
      key: "tdapSkinPaddle",
      label: "Skin Paddle Orientation",
      type: "select",
      options: [
        { value: "transverse", label: "Transverse" },
        { value: "vertical", label: "Vertical" },
        { value: "oblique", label: "Oblique" },
        { value: "propeller", label: "Propeller" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  Fibula
  // ════════════════════════════════════════════
  fibula: [
    {
      key: "fibulaTissueComposition",
      label: "Tissue Composition",
      type: "select",
      options: [
        { value: "bone_only", label: "Bone only" },
        { value: "osteocutaneous", label: "Osteocutaneous (with skin paddle)" },
        { value: "osteomyocutaneous", label: "Osteomyocutaneous (with FHL/soleus)" },
      ],
    },
    {
      key: "fibulaOsteotomyCount",
      label: "Number of Osteotomies",
      type: "select",
      required: true,
      options: [
        { value: "0", label: "0" },
        { value: "1", label: "1" },
        { value: "2", label: "2" },
        { value: "3", label: "3" },
        { value: "4", label: "4" },
        { value: "5", label: "5+" },
      ],
    },
    {
      key: "fibulaBarrel",
      label: "Barrel Configuration",
      type: "select",
      required: true,
      options: [
        { value: "single", label: "Single-barrel" },
        { value: "double", label: "Double-barrel" },
        { value: "hybrid_1_2_1", label: "Hybrid 1-2-1" },
        { value: "biaxial_double", label: "Biaxial double-barrel (for maxilla)" },
      ],
    },
    {
      key: "fibulaSkinPaddleType",
      label: "Skin Paddle Perforator Type (Yadav)",
      type: "select",
      options: [
        { value: "type_a_septocutaneous", label: "Type A — Septocutaneous (most common)" },
        { value: "type_b_septo_musculo", label: "Type B — Septo + musculocutaneous" },
        { value: "type_c_musculocutaneous", label: "Type C — Musculocutaneous only" },
        { value: "type_d_popliteal", label: "Type D — Popliteal artery supply (rare)" },
      ],
    },
    {
      key: "fibulaPlanningMethod",
      label: "Surgical Planning Method",
      type: "select",
      options: [
        { value: "freehand", label: "Freehand" },
        { value: "vsp_models", label: "VSP with stereolithographic models" },
        { value: "vsp_cutting_guides", label: "VSP with cutting guides" },
        { value: "vsp_psi", label: "VSP with patient-specific plates (PSI)" },
        { value: "in_house_vsp", label: "In-house VSP" },
      ],
    },
    {
      key: "fibulaBoneLengthCm",
      label: "Bone Length Harvested",
      type: "number",
      unit: "cm",
      placeholder: "12",
    },
    {
      key: "fibulaSkinPaddleCount",
      label: "Number of Skin Paddles",
      type: "select",
      options: [
        { value: "0", label: "0" },
        { value: "1", label: "1" },
        { value: "2", label: "2" },
        { value: "3", label: "3" },
      ],
    },
    {
      key: "fibulaFixation",
      label: "Fixation Method",
      type: "select",
      options: [
        { value: "reconstruction_plate", label: "Reconstruction plate" },
        { value: "miniplates", label: "Miniplates" },
        { value: "patient_specific_plate", label: "Patient-specific plate" },
        { value: "combination", label: "Combination" },
      ],
    },
    {
      key: "fibulaDentalImplant",
      label: "Dental Implant Timing",
      type: "select",
      options: [
        { value: "immediate", label: "Immediate ('Jaw in a Day')" },
        { value: "delayed", label: "Delayed" },
        { value: "not_planned", label: "Not planned" },
      ],
    },
    {
      key: "fibulaReconSite",
      label: "Reconstruction Site",
      type: "select",
      options: [
        { value: "mandible", label: "Mandible" },
        { value: "maxilla", label: "Maxilla" },
        { value: "long_bone", label: "Long bone" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  Scapular System
  // ════════════════════════════════════════════
  scapular: [
    {
      key: "scapularSkinPaddle",
      label: "Skin Paddle Type",
      type: "select",
      required: true,
      options: [
        { value: "scapular", label: "Scapular (transverse, CSA transverse branch)" },
        { value: "parascapular", label: "Parascapular (vertical, CSA descending branch)" },
        { value: "both_boomerang", label: "Both — boomerang" },
        { value: "none", label: "None" },
      ],
    },
    {
      key: "scapularBoneComponent",
      label: "Bone Component",
      type: "select",
      options: [
        { value: "none", label: "None" },
        { value: "lateral_border", label: "Lateral scapular border (CSA periosteal)" },
        { value: "scapular_tip", label: "Scapular tip/angle (angular branch from TDA)" },
        { value: "both", label: "Both (bipedicled bone)" },
      ],
    },
    {
      key: "scapularVascularPedicle",
      label: "Vascular Pedicle",
      type: "select",
      options: [
        { value: "csa_only", label: "CSA only" },
        { value: "subscapular_extended", label: "Subscapular artery (extended)" },
        { value: "tda_for_tip", label: "TDA (for scapular tip)" },
      ],
    },
    {
      key: "scapularChimericCount",
      label: "Number of Chimeric Components",
      type: "select",
      options: [
        { value: "1", label: "1" },
        { value: "2", label: "2" },
        { value: "3", label: "3" },
        { value: "4", label: "4" },
        { value: "5", label: "5+ (mega-flap)" },
      ],
    },
  ],

  // Use same config for parascapular
  parascapular: [
    {
      key: "scapularSkinPaddle",
      label: "Skin Paddle Type",
      type: "select",
      required: true,
      options: [
        { value: "scapular", label: "Scapular (transverse, CSA transverse branch)" },
        { value: "parascapular", label: "Parascapular (vertical, CSA descending branch)" },
        { value: "both_boomerang", label: "Both — boomerang" },
        { value: "none", label: "None" },
      ],
    },
    {
      key: "scapularBoneComponent",
      label: "Bone Component",
      type: "select",
      options: [
        { value: "none", label: "None" },
        { value: "lateral_border", label: "Lateral scapular border" },
        { value: "scapular_tip", label: "Scapular tip/angle" },
        { value: "both", label: "Both" },
      ],
    },
    {
      key: "scapularVascularPedicle",
      label: "Vascular Pedicle",
      type: "select",
      options: [
        { value: "csa_only", label: "CSA only" },
        { value: "subscapular_extended", label: "Subscapular artery (extended)" },
        { value: "tda_for_tip", label: "TDA (for scapular tip)" },
      ],
    },
    {
      key: "scapularChimericCount",
      label: "Number of Chimeric Components",
      type: "select",
      options: [
        { value: "1", label: "1" },
        { value: "2", label: "2" },
        { value: "3", label: "3" },
        { value: "4", label: "4" },
        { value: "5", label: "5+ (mega-flap)" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  SGAP
  // ════════════════════════════════════════════
  sgap: [
    {
      key: "gapSubtype",
      label: "GAP Variant",
      type: "select",
      options: [
        { value: "sgap", label: "SGAP (standard)" },
        { value: "sc_gap", label: "sc-GAP (septocutaneous, between glut max + medius)" },
      ],
    },
    {
      key: "sgapSkinPaddle",
      label: "Skin Paddle Design",
      type: "select",
      required: true,
      options: [
        { value: "oblique", label: "Oblique (standard, PSIS-to-GT)" },
        { value: "transverse", label: "Transverse" },
        { value: "modified_lateral", label: "Modified lateral (for sc-GAP)" },
      ],
    },
    {
      key: "gapPerforatorType",
      label: "Perforator Type",
      type: "select",
      options: [
        { value: "musculocutaneous", label: "Musculocutaneous" },
        { value: "septocutaneous", label: "Septocutaneous" },
      ],
    },
    {
      key: "gapSensate",
      label: "Sensate (superior cluneal nerves)",
      type: "boolean",
    },
    {
      key: "gapStacked",
      label: "Stacked Configuration",
      type: "boolean",
    },
    {
      key: "gapPositionChange",
      label: "Position Change Required",
      type: "boolean",
    },
  ],

  // ════════════════════════════════════════════
  //  IGAP
  // ════════════════════════════════════════════
  igap: [
    {
      key: "igapSkinPaddle",
      label: "Skin Paddle Design",
      type: "select",
      required: true,
      options: [
        { value: "in_the_crease", label: "In-the-crease (scar in gluteal fold)" },
        { value: "oblique", label: "Oblique" },
        { value: "transverse", label: "Transverse" },
      ],
    },
    {
      key: "gapPerforatorType",
      label: "Perforator Type",
      type: "select",
      options: [
        { value: "musculocutaneous", label: "Musculocutaneous" },
        { value: "septocutaneous", label: "Septocutaneous" },
      ],
    },
    {
      key: "gapSensate",
      label: "Sensate",
      type: "boolean",
    },
    {
      key: "gapStacked",
      label: "Stacked Configuration",
      type: "boolean",
    },
    {
      key: "gapPositionChange",
      label: "Position Change Required",
      type: "boolean",
    },
  ],

  // ════════════════════════════════════════════
  //  RFFF (Radial Forearm)
  // ════════════════════════════════════════════
  radial_forearm: [
    {
      key: "rfffTissueComposition",
      label: "Tissue Composition",
      type: "select",
      required: true,
      options: [
        { value: "fasciocutaneous", label: "Fasciocutaneous" },
        { value: "osteocutaneous", label: "Osteocutaneous (with radius)" },
        { value: "adipofascial", label: "Adipofascial (no skin)" },
        { value: "composite_palmaris", label: "Composite with palmaris longus" },
        { value: "composite_neuroteno", label: "Composite neuro-teno-cutaneous" },
      ],
    },
    {
      key: "rfffSensateNerve",
      label: "Sensate Innervation",
      type: "select",
      options: [
        { value: "non_sensate", label: "Non-sensate" },
        { value: "labcn", label: "LABCN (lateral antebrachial cutaneous)" },
        { value: "mabcn", label: "MABCN (medial antebrachial cutaneous)" },
        { value: "both", label: "Both" },
      ],
    },
    {
      key: "rfffDissectionPlane",
      label: "Dissection Plane",
      type: "select",
      options: [
        { value: "subfascial", label: "Subfascial (standard)" },
        { value: "suprafascial", label: "Suprafascial (preserves fascia over tendons)" },
      ],
    },
    {
      key: "rfffVariant",
      label: "Forearm Variant",
      type: "select",
      options: [
        { value: "radial", label: "Radial (RFFF)" },
        { value: "ulnar", label: "Ulnar (UFFF)" },
      ],
    },
    {
      key: "rfffConfiguration",
      label: "Flap Configuration",
      type: "select",
      options: [
        { value: "standard", label: "Standard" },
        { value: "folded", label: "Folded" },
        { value: "tubed", label: "Tubed (pharyngoesophageal)" },
      ],
    },
    {
      key: "rfffPalmarisIncluded",
      label: "Palmaris Longus Included",
      type: "select",
      options: [
        { value: "yes", label: "Yes" },
        { value: "no", label: "No" },
        { value: "absent", label: "Absent" },
      ],
    },
    {
      key: "rfffVenousDrainage",
      label: "Venous Drainage",
      type: "select",
      options: [
        { value: "venae_comitantes", label: "Venae comitantes" },
        { value: "cephalic_vein", label: "Cephalic vein" },
        { value: "both", label: "Both" },
      ],
    },
    {
      key: "rfffBoneSegmentCm",
      label: "Bone Segment Length (if osteocutaneous)",
      type: "number",
      unit: "cm",
      placeholder: "10",
      showWhen: { key: "rfffTissueComposition", values: ["osteocutaneous"] },
    },
    {
      key: "rfffProphylacticPlating",
      label: "Prophylactic Plating",
      type: "boolean",
      showWhen: { key: "rfffTissueComposition", values: ["osteocutaneous"] },
    },
    {
      key: "rfffSkinPaddleCount",
      label: "Number of Skin Paddles",
      type: "select",
      options: [
        { value: "1", label: "1" },
        { value: "2", label: "2 (bipaddle)" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  MSAP (Medial Sural Artery Perforator)
  // ════════════════════════════════════════════
  medial_sural: [
    {
      key: "msapTissueComposition",
      label: "Tissue Composition",
      type: "select",
      options: [
        { value: "fasciocutaneous", label: "Fasciocutaneous" },
        { value: "adipofascial", label: "Adipofascial" },
        { value: "chimeric_gastrocnemius", label: "Chimeric with medial gastrocnemius" },
      ],
    },
    {
      key: "msapBranchingPattern",
      label: "MSA Branching Pattern (Dusseldorp)",
      type: "select",
      required: true,
      options: [
        { value: "type_i_single", label: "Type I — Single branch (31%)" },
        { value: "type_iia_dual_superior", label: "Type IIa — Dual, takeoff superior (35%, best)" },
        { value: "type_iib_dual_inferior", label: "Type IIb — Dual, takeoff inferior (24%)" },
        { value: "type_iii_triple", label: "Type III — 3+ branches (10%)" },
      ],
    },
    {
      key: "msapPerforatorCourse",
      label: "Subcutaneous Perforator Course",
      type: "select",
      options: [
        { value: "type_1_direct", label: "Type 1 — Direct vertical (31%)" },
        { value: "type_2_oblique", label: "Type 2 — Oblique (57%, most common)" },
        { value: "type_3_tortuous", label: "Type 3 — Tortuous (12%)" },
      ],
    },
    {
      key: "msapSensate",
      label: "Sensate",
      type: "select",
      options: [
        { value: "non_sensate", label: "Non-sensate" },
        { value: "medial_sural_cutaneous", label: "Medial sural cutaneous nerve" },
        { value: "sural_nerve", label: "Sural nerve (nerve-through-flap)" },
      ],
    },
    {
      key: "msapDominantBranch",
      label: "Dominant Branch",
      type: "select",
      options: [
        { value: "lateral", label: "Lateral" },
        { value: "medial", label: "Medial" },
      ],
    },
    {
      key: "msapChimericMuscle",
      label: "Chimeric Muscle Component",
      type: "select",
      options: [
        { value: "none", label: "None" },
        { value: "medial_gastrocnemius", label: "Medial gastrocnemius segment" },
      ],
    },
    {
      key: "msapThinning",
      label: "Flap Thinning",
      type: "select",
      options: [
        { value: "standard", label: "Standard" },
        { value: "thinned", label: "Thinned" },
      ],
    },
  ],

  // ════════════════════════════════════════════
  //  Serratus Anterior
  // ════════════════════════════════════════════
  serratus_anterior: [
    {
      key: "serratusSlipCount",
      label: "Number of Muscle Slips Harvested",
      type: "select",
      required: true,
      options: [
        { value: "1", label: "1" },
        { value: "2", label: "2" },
        { value: "3", label: "3 (standard lower 3)" },
        { value: "4", label: "4" },
        { value: "5", label: "5 (maximum on single pedicle)" },
      ],
    },
    {
      key: "serratusSpecificSlips",
      label: "Specific Slips Taken",
      type: "text",
      placeholder: "e.g., 7th, 8th, 9th",
    },
    {
      key: "serratusTissueComposition",
      label: "Tissue Composition",
      type: "select",
      options: [
        { value: "muscle_only", label: "Muscle only" },
        { value: "myocutaneous", label: "Myocutaneous (+ skin paddle)" },
        { value: "fascia_only", label: "Fascia only (carpaccio technique)" },
        { value: "osteomuscular", label: "Osteomuscular (+ rib)" },
        { value: "osteomyocutaneous", label: "Osteomyocutaneous (+ rib + skin)" },
      ],
    },
    {
      key: "serratusRibIncluded",
      label: "Rib Included",
      type: "boolean",
    },
    {
      key: "serratusRibNumbers",
      label: "Rib Numbers",
      type: "text",
      showWhen: { key: "serratusRibIncluded", values: ["true"] },
      placeholder: "e.g., 6th, 7th",
    },
    {
      key: "serratusNerveStatus",
      label: "Long Thoracic Nerve Status",
      type: "select",
      options: [
        { value: "preserved", label: "Preserved (functional)" },
        { value: "divided", label: "Divided (denervated)" },
      ],
    },
    {
      key: "serratusNerveTarget",
      label: "Nerve Coaptation Target (if functional)",
      type: "select",
      showWhen: { key: "serratusNerveStatus", values: ["preserved"] },
      options: [
        { value: "masseteric", label: "Masseteric" },
        { value: "facial_nerve", label: "Facial nerve branches" },
        { value: "cfng", label: "Cross-face nerve graft" },
      ],
    },
    {
      key: "serratusChimeric",
      label: "Chimeric Configuration",
      type: "select",
      options: [
        { value: "serratus_alone", label: "Serratus alone" },
        { value: "plus_ld", label: "+ Latissimus dorsi" },
        { value: "plus_ld_rib", label: "+ LD + Rib" },
        { value: "plus_ld_scapular_bone", label: "+ LD + Scapular bone" },
        { value: "mega_flap", label: "Subscapular mega-flap (3+ components)" },
      ],
    },
  ],

  // TUG uses same config as gracilis
  tug: [
    {
      key: "gracilisTissueComposition",
      label: "Tissue Composition",
      type: "select",
      required: true,
      options: [
        { value: "muscle_only", label: "Muscle only" },
        { value: "myocutaneous", label: "Myocutaneous" },
        { value: "myofasciocutaneous", label: "Myofasciocutaneous" },
        { value: "perforator_only", label: "Perforator only" },
      ],
    },
    {
      key: "gracilisSkinPaddle",
      label: "Skin Paddle Orientation",
      type: "select",
      required: true,
      options: [
        { value: "transverse_tug", label: "Transverse (TUG/TMG)" },
        { value: "oblique_dug", label: "Oblique/Diagonal (DUG)" },
        { value: "l_shaped", label: "L-shaped" },
      ],
    },
    {
      key: "gracilisHarvestExtent",
      label: "Muscle Harvest Extent",
      type: "select",
      options: [
        { value: "complete", label: "Complete" },
        { value: "partial_proximal", label: "Partial-proximal" },
        { value: "segmental", label: "Segmental" },
      ],
    },
  ],
};

/**
 * Elevation plane options per flap type.
 * ALT has the most granular set. Most other flaps are subfascial/suprafascial.
 * Some flaps (DIEP, fibula) don't use elevation plane at all.
 */
export const FLAP_ELEVATION_PLANES: Partial<Record<FreeFlap, string[]>> = {
  alt: ["subfascial", "epifascial", "thin", "superthin", "ultrathin", "subdermal"],
  scip: ["subfascial", "suprafascial"],
  tdap: ["subfascial", "suprafascial"],
  latissimus_dorsi: ["subfascial", "suprafascial"],
  radial_forearm: ["subfascial", "suprafascial"],
  medial_sural: ["subfascial", "suprafascial"],
  pap: ["subfascial", "suprafascial"],
  gracilis: ["subfascial", "suprafascial"],
  tug: ["subfascial", "suprafascial"],
  sgap: ["subfascial", "suprafascial"],
  igap: ["subfascial", "suprafascial"],
  serratus_anterior: ["subfascial", "suprafascial"],
  parascapular: ["subfascial", "suprafascial"],
  scapular: ["subfascial", "suprafascial"],
  // DIEP, SIEA, fibula: elevation plane not applicable — omitted
};
```

---

## Step 3: Create `client/components/FlapSpecificFields.tsx`

This component reads the `FLAP_FIELD_CONFIG` registry and renders the appropriate fields for the selected flap type. Create `client/components/FlapSpecificFields.tsx`:

```typescript
import React from "react";
import { View, StyleSheet, Pressable, Switch, Platform } from "react-native";
import * as Haptics from "expo-haptics";
import { ThemedText } from "@/components/ThemedText";
import { FormField } from "@/components/FormField";
import { useTheme } from "@/hooks/useTheme";
import { BorderRadius, Spacing } from "@/constants/theme";
import { FLAP_FIELD_CONFIG, type FlapFieldDefinition } from "@/data/flapFieldConfig";
import type { FreeFlap, FlapSpecificDetails } from "@/types/case";

interface FlapSpecificFieldsProps {
  flapType: FreeFlap;
  details: FlapSpecificDetails;
  onUpdate: (details: FlapSpecificDetails) => void;
}

export function FlapSpecificFields({
  flapType,
  details,
  onUpdate,
}: FlapSpecificFieldsProps) {
  const { theme } = useTheme();
  const fieldConfig = FLAP_FIELD_CONFIG[flapType];

  if (!fieldConfig || fieldConfig.length === 0) {
    return null;
  }

  const getValue = (key: string): any => (details as any)[key];
  const setValue = (key: string, value: any) => {
    onUpdate({ ...details, [key]: value });
  };

  const isFieldVisible = (field: FlapFieldDefinition): boolean => {
    if (!field.showWhen) return true;
    const currentValue = String(getValue(field.showWhen.key) ?? "");
    return field.showWhen.values.includes(currentValue);
  };

  const visibleFields = fieldConfig.filter(isFieldVisible);

  if (visibleFields.length === 0) return null;

  return (
    <View style={styles.container}>
      <ThemedText style={[styles.sectionTitle, { color: theme.text }]}>
        Flap-Specific Details
      </ThemedText>
      <ThemedText style={[styles.sectionSubtitle, { color: theme.textSecondary }]}>
        Parameters specific to the selected flap type
      </ThemedText>

      {visibleFields.map((field) => {
        switch (field.type) {
          case "select":
            return (
              <SelectField
                key={field.key}
                field={field}
                value={String(getValue(field.key) ?? "")}
                onSelect={(v) => {
                  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                  setValue(field.key, v);
                }}
              />
            );
          case "boolean":
            return (
              <BooleanField
                key={field.key}
                field={field}
                value={getValue(field.key) ?? false}
                onChange={(v) => {
                  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
                  setValue(field.key, v);
                }}
              />
            );
          case "number":
            return (
              <FormField
                key={field.key}
                label={`${field.label}${field.required ? " *" : ""}`}
                value={getValue(field.key) != null ? String(getValue(field.key)) : ""}
                onChangeText={(v) => setValue(field.key, v ? parseFloat(v) : undefined)}
                placeholder={field.placeholder}
                keyboardType="decimal-pad"
                unit={field.unit}
              />
            );
          case "text":
            return (
              <FormField
                key={field.key}
                label={`${field.label}${field.required ? " *" : ""}`}
                value={String(getValue(field.key) ?? "")}
                onChangeText={(v) => setValue(field.key, v || undefined)}
                placeholder={field.placeholder}
              />
            );
          default:
            return null;
        }
      })}
    </View>
  );
}

// ─── Internal sub-components ───

function SelectField({
  field,
  value,
  onSelect,
}: {
  field: FlapFieldDefinition;
  value: string;
  onSelect: (value: string) => void;
}) {
  const { theme } = useTheme();

  return (
    <View style={styles.fieldContainer}>
      <ThemedText style={[styles.fieldLabel, { color: theme.textSecondary }]}>
        {field.label}{field.required ? " *" : ""}
      </ThemedText>
      {field.hint ? (
        <ThemedText style={[styles.fieldHint, { color: theme.textSecondary }]}>
          {field.hint}
        </ThemedText>
      ) : null}
      <View style={styles.optionsWrap}>
        {(field.options || []).map((option) => (
          <Pressable
            key={option.value}
            style={[
              styles.optionChip,
              {
                backgroundColor:
                  value === option.value
                    ? theme.link + "20"
                    : theme.backgroundDefault,
                borderColor:
                  value === option.value ? theme.link : theme.border,
              },
            ]}
            onPress={() => onSelect(option.value)}
          >
            <ThemedText
              style={[
                styles.optionText,
                {
                  color: value === option.value ? theme.link : theme.text,
                  fontWeight: value === option.value ? "600" : "400",
                },
              ]}
            >
              {option.label}
            </ThemedText>
          </Pressable>
        ))}
      </View>
    </View>
  );
}

function BooleanField({
  field,
  value,
  onChange,
}: {
  field: FlapFieldDefinition;
  value: boolean;
  onChange: (value: boolean) => void;
}) {
  const { theme } = useTheme();

  return (
    <View style={styles.booleanRow}>
      <ThemedText style={[styles.booleanLabel, { color: theme.text }]}>
        {field.label}{field.required ? " *" : ""}
      </ThemedText>
      <Switch
        value={!!value}
        onValueChange={onChange}
        trackColor={{ false: theme.border, true: theme.link + "60" }}
        thumbColor={value ? theme.link : theme.textSecondary}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    marginTop: Spacing.md,
    paddingTop: Spacing.md,
    borderTopWidth: 1,
    borderTopColor: "rgba(0,0,0,0.05)",
  },
  sectionTitle: {
    fontSize: 14,
    fontWeight: "600",
    marginBottom: 2,
  },
  sectionSubtitle: {
    fontSize: 12,
    marginBottom: Spacing.md,
  },
  fieldContainer: {
    marginBottom: Spacing.md,
  },
  fieldLabel: {
    fontSize: 14,
    fontWeight: "500",
    marginBottom: Spacing.xs,
  },
  fieldHint: {
    fontSize: 12,
    fontStyle: "italic",
    marginBottom: Spacing.xs,
  },
  optionsWrap: {
    flexDirection: "row",
    flexWrap: "wrap",
    gap: Spacing.xs,
  },
  optionChip: {
    paddingHorizontal: Spacing.md,
    paddingVertical: Spacing.sm,
    borderRadius: BorderRadius.sm,
    borderWidth: 1,
  },
  optionText: {
    fontSize: 13,
  },
  booleanRow: {
    flexDirection: "row",
    alignItems: "center",
    justifyContent: "space-between",
    marginBottom: Spacing.md,
    paddingVertical: Spacing.xs,
  },
  booleanLabel: {
    fontSize: 14,
    fontWeight: "500",
    flex: 1,
    marginRight: Spacing.md,
  },
});
```

---

## Step 4: Update `client/components/FreeFlapPicker.tsx`

Update the elevation plane logic to use the new per-flap config. Replace the `ALT_ELEVATION_PLANES` and `NON_ALT_ELEVATION_PLANES` constants and the elevation plane rendering with config-driven logic:

In `FreeFlapPicker.tsx`, make these changes:

1. Add import:
```typescript
import { FLAP_ELEVATION_PLANES } from "@/data/flapFieldConfig";
```

2. Remove the old `ALT_ELEVATION_PLANES` and `NON_ALT_ELEVATION_PLANES` constants.

3. Replace the elevation plane logic:
```typescript
const elevationOptions = flapType
  ? (FLAP_ELEVATION_PLANES[flapType] || ["subfascial", "suprafascial"]).map(
      (plane) => plane as ElevationPlane
    )
  : [];
```

4. In `handleFlapSelect`, replace the elevation plane reset logic:
```typescript
const handleFlapSelect = (flap: FreeFlap) => {
  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
  onFlapTypeChange(flap);
  
  const newPlanes = FLAP_ELEVATION_PLANES[flap];
  if (newPlanes && elevationPlane && !newPlanes.includes(elevationPlane)) {
    onElevationPlaneChange("subfascial" as ElevationPlane);
  }
};
```

5. Update `ALL_FLAPS` array to include `scapular`:
```typescript
const ALL_FLAPS: FreeFlap[] = [
  "alt",
  "latissimus_dorsi",
  "gracilis",
  "tug",
  "scip",
  "siea",
  "radial_forearm",
  "fibula",
  "diep",
  "medial_sural",
  "sgap",
  "igap",
  "pap",
  "tdap",
  "parascapular",
  "scapular",
  "serratus_anterior",
  "other",
];
```

6. Only show elevation plane picker for flaps that have it (skip DIEP, SIEA, fibula):
```typescript
{flapType && FLAP_ELEVATION_PLANES[flapType] ? (
  <View style={styles.elevationSection}>
    <PickerField ... />
  </View>
) : null}
```

---

## Step 5: Update `client/components/ProcedureClinicalDetails.tsx`

Integrate `FlapSpecificFields` into `FreeFlapClinicalFields`. Add the import and render the component after the existing generic fields:

1. Add import:
```typescript
import { FlapSpecificFields } from "@/components/FlapSpecificFields";
```

2. In the `FreeFlapClinicalFields` component, after the existing flap dimension fields and before the closing `</View>`, add:

```typescript
{flapType ? (
  <FlapSpecificFields
    flapType={flapType}
    details={clinicalDetails.flapSpecificDetails || {}}
    onUpdate={(flapSpecific) =>
      onUpdate({ ...clinicalDetails, flapSpecificDetails: flapSpecific })
    }
  />
) : null}
```

This renders the flap-specific conditional fields section after flap dimensions and before (or after) the anastomosis section. Place it **after** the flap dimension row and **before** the Anastomoses subsection title for logical surgical decision order.

---

## Step 6: Backward Compatibility

No migration needed. Existing cases simply won't have `flapSpecificDetails` populated — the new fields all render as empty/unselected. The `FlapSpecificDetails` interface has all optional properties, so `undefined` is the default for every field.

---

## Step 7: Smoke Test Checklist

After implementation, verify:

- [ ] Selecting ALT shows: Tissue Composition, Perforator Type, Pedicle Source, ABC Location, Skin Paddles, Flow-through, Sensate, Primary Thinning, Extended Variant + 6-level elevation plane
- [ ] Selecting DIEP shows: Perforator Row, MS-TRAM, Perfusion Zones, Gill, Config, Venous Supercharge, Extent, Motor Nerve, Sensory Neurotization + NO elevation plane
- [ ] Selecting Fibula shows: Tissue Comp, Osteotomy Count, Barrel, Yadav Type, Planning, Bone Length, Skin Paddles, Fixation, Dental Implant, Recon Site + NO elevation plane
- [ ] Selecting Gracilis shows functional transfer fields; toggling "Functional Transfer" ON reveals nerve coaptation target and CFNG staging fields
- [ ] Selecting RFFF → Osteocutaneous reveals bone segment length and prophylactic plating fields
- [ ] Selecting TDAP shows conversion field (completed/converted)
- [ ] Selecting SCIP shows lymphatic component field
- [ ] Selecting Serratus → Rib Included ON reveals rib numbers field
- [ ] Existing cases load without errors (no migration needed)
- [ ] New case with flap-specific details saves and loads correctly
- [ ] Changing flap type resets flap-specific details (or preserves shared fields — design choice, recommend reset)

---

## Important Notes for the Agent

1. **Do NOT modify the database schema** (`shared/schema.ts`). The `flapSpecificDetails` lives inside the `clinicalDetails` JSON blob which is already stored on each case procedure. No new DB columns needed.

2. **Do NOT remove any existing fields** from `FreeFlapDetails` — only add `flapSpecificDetails` to it. Existing fields (perforatorCount, elevationPlane, flapWidthCm, etc.) remain as top-level generic fields.

3. **The `SelectField` component** already exists as a private component inside `ProcedureClinicalDetails.tsx`. The new `FlapSpecificFields.tsx` component has its own version since it needs different styling (wrapped chips vs. horizontal row). These can be refactored later.

4. **When the user changes flap type**, reset `flapSpecificDetails` to `{}` to avoid stale data from a previously selected flap. Add this to the `handleFlapTypeChange` function in `ProcedureClinicalDetails.tsx`.

5. **File size is large** — `flapFieldConfig.ts` will be ~900+ lines. This is expected and correct. It's a data file, not logic — it's the single source of truth for all flap-specific field rendering.